<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Tickets</title>

  <!-- Firebase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

  <!-- QRCode Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8faff;
      padding: 20px;
    }
    h2 { color: #1a1a2e; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #1a1a2e;
      color: white;
    }
    td input {
      width: 80%;
      padding: 5px;
    }
    button {
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #3399ff;
    }
    .qrcode {
      width: 80px;
      height: 80px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h2>üéü Admin Dashboard - Rewarder Tickets</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Ticket Type</th>
        <th>Amount</th>
        <th>Tx Ref</th>
        <th>QR Code</th>
        <th>Change Name</th>
        <th>Send Email</th>
      </tr>
    </thead>
    <tbody id="ticketTable"></tbody>
  </table>

  <script>
    // üîπ Firebase Config
    const firebaseConfig = {
    apiKey: "AIzaSyDW8V2SjNITrA4LcdmeILh944mTbOKnM0c",
    authDomain: "rewarderhub.firebaseapp.com",
    projectId: "rewarderhub",
    storageBucket: "rewarderhub.firebasestorage.app",
    messagingSenderId: "85965945106",
    appId: "1:85965945106:web:fa0a57d8968926e1041bcb",
    measurementId: "G-F2ERB5NGN0"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ticketTable = document.getElementById("ticketTable");

    // Fetch tickets
    async function loadTickets() {
      const snapshot = await db.collection("tickets").get();
      ticketTable.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const row = document.createElement("tr");

        // Ticket data row
        row.innerHTML = `
          <td>${data.name}</td>
          <td>${data.email}</td>
          <td>${data.ticketType}</td>
          <td>‚Ç¶${data.amount}</td>
          <td>${data.txRef}</td>
          <td><div id="qr-${doc.id}" class="qrcode"></div></td>
          <td>
            <input type="text" id="name-${doc.id}" value="${data.name}">
            <button onclick="updateName('${doc.id}')">Save</button>
          </td>
          <td>
            <button onclick="sendEmail('${data.email}', '${data.name}', '${data.txRef}')">üìß Send</button>
          </td>
        `;

        ticketTable.appendChild(row);

        // Generate QR
        new QRCode(document.getElementById("qr-" + doc.id), {
          text: data.txRef,
          width: 80,
          height: 80
        });
      });
    }

    // Update Name
    async function updateName(id) {
      const newName = document.getElementById("name-" + id).value;
      await db.collection("tickets").doc(id).update({ name: newName });
      alert("‚úÖ Name updated!");
      loadTickets();
    }

    // Send Email via Google Apps Script
    async function sendEmail(email, name, txRef) {
      const scriptURL = "https://script.google.com/macros/s/AKfycbxALG8J-bOUjqOYSiZBY3fqv-AukRm3rO-1rin_XnAEhYYtVVJkkhJXKRhpC5hQxU78/exec";
      try {
        await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ email, name, txRef }),
          headers: { "Content-Type": "application/json" }
        });
        alert("üì© Email sent to " + email);
      } catch (err) {
        alert("‚ùå Error sending email: " + err.message);
      }
    }

    loadTickets();
  </script>
</body>
</html>
